name: Build & Package

on:
  workflow_dispatch:
    inputs:
      platform:
        description: "Target platform"
        required: true
        default: "all"
        type: choice
        options:
          - all
          - windows
          - macos
          - linux
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build-windows:
    if: ${{ github.event_name == 'push' || inputs.platform == 'all' || inputs.platform == 'windows' }}
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Build Electron app
        run: npm run electron:build

      - name: Package for Windows
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: npx electron-builder --win --config electron-builder.yml --publish always

  build-macos:
    if: ${{ github.event_name == 'push' || inputs.platform == 'all' || inputs.platform == 'macos' }}
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Build Electron app
        run: npm run electron:build

      - name: Package for macOS (x64 + arm64)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: npx electron-builder --mac --config electron-builder.yml --publish always

  build-linux:
    if: ${{ github.event_name == 'push' || inputs.platform == 'all' || inputs.platform == 'linux' }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        arch: [x64, arm64]
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Build Electron app
        run: npm run electron:build

      - name: Package for Linux (${{ matrix.arch }})
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: npx electron-builder --linux --${{ matrix.arch }} --config electron-builder.yml --publish always

  release:
    if: ${{ always() && github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v') && !contains(needs.*.result, 'cancelled') }}
    needs: [build-windows, build-macos, build-linux]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version and previous tag
        id: meta
        run: |
          VERSION=${GITHUB_REF_NAME#v}
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          PREV_TAG=$(git tag --sort=-creatordate | grep '^v' | sed -n '2p' || echo "")
          echo "prev_tag=$PREV_TAG" >> "$GITHUB_OUTPUT"

      - name: Generate changelog
        id: changelog
        run: |
          PREV_TAG="${{ steps.meta.outputs.prev_tag }}"
          if [ -n "$PREV_TAG" ]; then
            RANGE="${PREV_TAG}..HEAD"
          else
            RANGE="HEAD"
          fi
          {
            echo "changelog<<CHANGELOG_EOF"
            git log "$RANGE" --pretty=format:'| `%h` | %s |'
            echo ""
            echo "CHANGELOG_EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Update release notes
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ steps.meta.outputs.version }}"
          PREV_TAG="${{ steps.meta.outputs.prev_tag }}"

          cat > release-notes.md << 'NOTES_EOF'
          ## Downloads

          **Windows**
          - **CodePilot Setup ${{ steps.meta.outputs.version }}.exe** — Windows installer (x64 + arm64)

          **macOS**
          - **CodePilot-${{ steps.meta.outputs.version }}-arm64.dmg** — macOS Apple Silicon (M1/M2/M3/M4)
          - **CodePilot-${{ steps.meta.outputs.version }}-x64.dmg** — macOS Intel

          **Linux**
          - **AppImage / deb / rpm** — x64 and arm64

          ## Installation

          **Windows**: Download the exe installer, double-click to install.

          **macOS**:
          1. Download the DMG for your chip architecture
          2. Open the DMG, drag CodePilot into Applications
          3. If you see a security prompt on first launch, go to **System Settings > Privacy & Security** and click "Open Anyway"
          4. Configure your Anthropic API Key in Settings

          **Linux**: Run the AppImage directly, or install via deb/rpm package.

          ## Requirements

          - Windows 10+ / macOS 12.0+ / Linux (glibc 2.31+)
          - Anthropic API Key or `ANTHROPIC_API_KEY` environment variable
          - Claude Code CLI recommended for code features

          ## Changelog
          NOTES_EOF

          if [ -n "$PREV_TAG" ]; then
            echo "" >> release-notes.md
            echo "| Commit | Description |" >> release-notes.md
            echo "|--------|-------------|" >> release-notes.md
            cat >> release-notes.md << 'CHANGELOG_INLINE_EOF'
          ${{ steps.changelog.outputs.changelog }}
          CHANGELOG_INLINE_EOF
          fi

          # Update the draft release created by electron-builder with full notes
          gh release edit "${GITHUB_REF_NAME}" \
            --title "CodePilot v${VERSION}" \
            --notes-file release-notes.md \
            --latest \
            --draft=false
